<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Merbridge now supports Ambient Mesh, no worry about CNI compatibility! | Merbridge</title>
<meta name=description content="Merbridge website"><meta property="og:title" content="Merbridge now supports Ambient Mesh, no worry about CNI compatibility!">
<meta property="og:description" content="This blog describes how Merbridge supports Ambient Mesh.">
<meta property="og:type" content="article">
<meta property="og:url" content="/blog/2022/11/11/ambient-mesh-support/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2022-11-11T00:00:00+00:00">
<meta property="article:modified_time" content="2022-11-25T13:22:47+08:00"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="Merbridge now supports Ambient Mesh, no worry about CNI compatibility!">
<meta itemprop=description content="This blog describes how Merbridge supports Ambient Mesh."><meta itemprop=datePublished content="2022-11-11T00:00:00+00:00">
<meta itemprop=dateModified content="2022-11-25T13:22:47+08:00">
<meta itemprop=wordCount content="1166">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Merbridge now supports Ambient Mesh, no worry about CNI compatibility!">
<meta name=twitter:description content="This blog describes how Merbridge supports Ambient Mesh.">
<link rel=preload href=/scss/main.min.2632ca806a74ced739b45e7001ee9dcd887d8c6053f398fc136b3e0b0da7be80.css as=style>
<link href=/scss/main.min.2632ca806a74ced739b45e7001ee9dcd887d8c6053f398fc136b3e0b0da7be80.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class="td-page td-blog">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/docs/><span>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/blog/><span class=active>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/blog/2022/11/11/ambient-mesh-support/>中文 Chinese</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5ed1053126b41c53e4ab09823123bc00.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5ed1053126b41c53e4ab09823123bc00.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<div class="nav-item dropdown d-block d-lg-none">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/blog/2022/11/11/ambient-mesh-support/>中文 Chinese</a>
</div>
</div>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li>
<a href=/blog/ title="Merbridge Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blog2023-li>
<a href=/blog/2023/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blog2023><span>Blogs of 2023</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230403osm-edge-demo-li>
<a href=/blog/2023/04/03/osm-edge-demo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230403osm-edge-demo><span>Test OSM Edge Integration with Merbridge</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog2022-li>
<a href=/blog/2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blog2022><span>Blogs of 2022</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20221111ambient-mesh-support-li>
<a href=/blog/2022/11/11/ambient-mesh-support/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20221111ambient-mesh-support><span class=td-sidebar-nav-active-item>Merbridge now supports Ambient Mesh, no worry about CNI compatibility!</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221108kuma-20-with-merbridge-li>
<a href=/blog/2022/11/08/kuma-2.0-with-merbridge/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221108kuma-20-with-merbridge><span>Merbridge helps Kuma reduce network latency by 12%</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221013ambient-mesh-data-path-li>
<a href=/blog/2022/10/13/ambient-mesh-data-path/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221013ambient-mesh-data-path><span>Deep Dive into Ambient Mesh - Traffic Path</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220518cni-mode-li>
<a href=/blog/2022/05/18/cni-mode/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220518cni-mode><span>Merbridge CNI Mode</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220423merbridge-and-cilium-li>
<a href=/blog/2022/04/23/merbridge-and-cilium/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220423merbridge-and-cilium><span>Merbridge and Cilium</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220329solo-io-livestream-li>
<a href=/blog/2022/03/29/solo-io-livestream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220329solo-io-livestream><span>Livestream with Solo.io</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220301merbridge-introduce-li>
<a href=/blog/2022/03/01/merbridge-introduce/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220301merbridge-introduce><span>Merbridge - Accelerate your mesh with eBPF</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleases-li>
<a href=/blog/releases/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleases><span>Version Release</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220720release-070-li>
<a href=/blog/2022/07/20/release-0.7.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220720release-070><span>Release 0.7.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220523release-060-li>
<a href=/blog/2022/05/23/release-0.6.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220523release-060><span>Release 0.6.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220330release-050-li>
<a href=/blog/2022/03/30/release-0.5.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220330release-050><span>Release 0.5.0</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/merbridge/merbridge/edit/main/content/en/blog/2022/ambient-mesh-support/index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/merbridge/merbridge/new/main/content/en/blog/2022/ambient-mesh-support/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/merbridge/merbridge/issues/new?title=Merbridge%20now%20supports%20Ambient%20Mesh,%20no%20worry%20about%20CNI%20compatibility!" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/merbridge/website/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/blog/2022/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#objectives>Objectives</a></li>
<li><a href=#pain-points-analysis>Pain points analysis</a></li>
<li><a href=#solution>Solution</a></li>
<li><a href=#usage-and-feedback>Usage and feedback</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main>
<div class=td-content>
<h1>Merbridge now supports Ambient Mesh, no worry about CNI compatibility!</h1>
<div class=lead>This blog describes how Merbridge supports Ambient Mesh.</div>
<div class="td-byline mb-4">
By <b>Kebe Liu</b> |
<time datetime=2022-11-11 class=text-muted>Friday, November 11, 2022</time>
</div>
<header class=article-meta>
<p class=reading-time><i class="fa fa-clock" aria-hidden=true></i> 6 minute read</p>
</header>
<p>In the blog <a href=../ambient-mesh-data-path/index.md>Deep Dive into Ambient Mesh - Traffic Path</a>,
we analyzed how Ambient Mesh forwards the ingress and egress traffic of Pod to ztunnel.
It is implemented by iptables + TPROXY + routing table. The traffic datapath is relatively
long compared to sidecar mode, and the principle is complicated. Moreover, it uses routing marks, which may cause
unexpected behaviors in some cases when it relies on CNI or it is running in a CNI with the bridge mode.
These severely limit the applicable scope of ambient mesh.</p>
<p>The main purpose of Merbridge is to replace iptables with eBPF to accelerate applications running in
a service mesh. Ambient Mesh is a new mode of Istio. It is necessary for Merbridge to support this new mode.
iptables is a powerful tool to block unwanted traffic, allow desired traffic, and redirect packets to specific
addresses and ports, but it also has some weaknesses. First, iptables uses a linear matching method.
When several applications simultaneously call a same program, conflicts may arise and make some features become unavailable.
Second, although it is flexible enough, it still cannot be programmed as freely as eBPF.
Therefore, replacing iptables with eBPF can help Ambient Mesh achieve traffic interception.</p>
<h2 id=objectives>Objectives</h2>
<p>As mentioned in <a href=../ambient-mesh-data-path/index.md>Deep Dive into Ambient Mesh - Traffic Path</a>,
we set two objectives:</p>
<ul>
<li>Outgoing traffic from pods in Ambient Mesh should be intercepted and redirected to port 15001 of ztunnel.</li>
<li>Traffic sent from host applications to pods in Ambient Mesh should be redirected to port 15006 of ztunnel.</li>
</ul>
<p>Since istioin and other network interface cards (NICs) are completely designed to adapt to the native Ambient Mesh, we don&rsquo;t need to make any changes.</p>
<h2 id=pain-points-analysis>Pain points analysis</h2>
<p>Ambient Mesh has a different operation mechanism from sidecars. According to the official definition of Istio,
adding a Pod to Ambient Mesh does not require restarting the Pod and no any sidecar-related process is running in the Pod. It means:</p>
<ol>
<li>Merbridge used the CNI mode to enable the eBPF program to get the current Pod IP to make policy decisions,
which is incompatible with ambient mesh. The reason is a pod will not be restarted after joining or
leaving the ambient mesh, nor will it call the CNI plug-in.</li>
<li>In the sidecar mode, the only thing you need to change is the destination address to <code>127.0.0.1:15001</code> in
the connect hook of eBPF, but in the ambient mesh you need to replace the desitination IP with that of ztunnel.</li>
</ol>
<p>In addtion, no sidecar-related process exists in a Pod running in an ambient mesh,
so the legacy method of checking whether a port such as 15006 is listening in the current Pod is no longer applicable.
It is necessary to redesign the scheme to check the environment where processes are running.</p>
<p>Therefore, based on the above analysis, it is required to redesign the entire interception scheme so that Merbridge can support the ambient mesh.</p>
<p>In summary, we need to implement the following features:</p>
<ul>
<li>Redesign a scheme for judging whether a Pod is running in the ambient mesh</li>
<li>Use eBPF to perceive current Pod IP regardless of CNIs</li>
<li>Enable eBPF programs to know the ztunnel IP on the current node</li>
</ul>
<h2 id=solution>Solution</h2>
<p>In version 0.7.2, cgroup id is used to improve the performance of the connect program.
Usually, each container in a Pod has a proper cgroup id, which can be obtained through the <code>bpf_get_current_cgroup_id</code>
function in the BPF program. The speed of the connect program can be optimized by writing IP information to a specific <code>cgroup_info_map</code>.</p>
<p>An ambient mesh is different from the legacy CNI listening on a special port in the network namespace for storing Pod-related information.
In the ambient mesh, cgroup id is useful. If cgroup id can be associated with the Pod IP, you can get the current Pod IP in eBPF.</p>
<p>Since CNI cannot be relied on anymore, we need change the scheme for obtaining the information of Pod status.
For this reason, we detect the creation and revocation actions of local Pods by watching the process creation and revocation.
We created a new tool to watch the process changes on a host: <a href=https://github.com/merbridge/process-watcher>process-watcher project</a>.</p>
<p>Read the cgroup id and ip information from the process ID and writing it to the <code>cgroup_info_map</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#000>tcg</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cgroupInfo</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>ID</span><span style=color:#000;font-weight:700>:</span>            <span style=color:#000>cgroupInode</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>IsInMesh</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>CgroupIp</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>uint32</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>_ip</span><span style=color:#000;font-weight:700>),</span>
		<span style=color:#000>Flags</span><span style=color:#000;font-weight:700>:</span>         <span style=color:#000>flag</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>DetectedFlags</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>cgrinfo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DetectedFlags</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000>AMBIENT_MESH_MODE_FLAG</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000>ZTUNNEL_FLAG</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ebpfs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetCgroupInfoMap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Update</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroupInode</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tcg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ebpf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateAny</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>Then get the current cgroup-related information in eBPF:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>__u64</span> <span style=color:#000>cgroup_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_get_current_cgroup_id</span><span style=color:#000;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_map_lookup_elem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroup_info_map</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroup_id</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>Now, we can learn whether the current container has the ambient mesh enabled and it is located in a mesh or not.</p>
<p>Second, for the ztunnel IP, Istio implements it by adding NIC and binding fixed IPs.
This scheme may have the risk of conflict, and the original addresses may be lost in some cases (such as SNAT).
So Merbridge gives up the scheme and directly obtains the ztunnel IPs on the control plane,
writes it into the map, and enables the eBPF program read it (this is faster).</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>inline</span> <span style=color:#000>__u32</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>get_ztunnel_ip</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>__u32</span> <span style=color:#000>ztunnel_ip_key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ZTUNNEL_KEY</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>__u32</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#000>bpf_map_lookup_elem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>settings</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>ztunnel_ip_key</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Then use the connect program to rewrite the destination address:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>user_ip4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ztunnel_ip</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>];</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>user_port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_htons</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>OUT_REDIRECT_PORT</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>With the association with the cgroup id, the Pod IP of current processes can be obtained in eBPF, so as to enforce policies.
Forward the traffic from the Pod in the ambient mesh to the ztunnel, so that Merbridge can be compatible with the ambient mesh.</p>
<p>This will be a capability that is adaptable to all CNIs and can avoid the problem that the native ambient mesh cannot work well in most CNI modes.</p>
<h2 id=usage-and-feedback>Usage and feedback</h2>
<p>Since the ambient mesh is still in its early stage and the support for ambient mode is relatively preliminary,
some problems have not been well resolved, so the code of supporting for the ambient mode has not been merged into the main branch.
If you want to experience the capability of Merbridge to implement traffic interception for ambient mesh instead of iptables,
you can perform the following steps (it is required to install the ambient mesh in advance):</p>
<ol>
<li>Disable Istio CNI (set <code>--set components.cni.enabled=false</code> during installation, or delete Istio CNI&rsquo;s DaemonSet <code>kubectl -n istio-system delete ds istio-cni</code>).</li>
<li>Remove the init container of ztunnel (because it initializes iptables rules and NICs, which is not required for Merbridge).</li>
<li>Install Merbridge by running <code>kubectl apply -f https://github.com/merbridge/merbridge/raw/ambient/deploy/all-in-one.yaml</code></li>
</ol>
<p>After the Merbridge is ready, you can use all capabilities of ambient mesh.</p>
<p><strong>*Attentions:</strong></p>
<ol>
<li>The Ambient mode under Kind is not supported currently (we have a plan to support it in the future)</li>
<li>The host kernel version needs to be not less than 5.7</li>
<li>cgroup v2 is required to be enabled</li>
<li>This mode is also compatible with sidecars</li>
<li>The debug mode will be enabled by default in an ambient mesh, which will have certain impact on performance</li>
</ol>
<p>For more details see <a href=https://github.com/merbridge/merbridge/tree/ambient>source code</a>.</p>
<p>If you have any question, please reach out to us with <a href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ>Slack</a> or add the wechat group to chat.</p>
<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
<li>
<a href=/blog/2022/11/08/kuma-2.0-with-merbridge/ aria-label="Previous - Merbridge helps Kuma reduce network latency by 12%" class="btn btn-primary"><span class=mr-1>←</span> Previous</a>
</li>
<a class="btn btn-primary disabled">Next <span class=ml-1>→</span></a>
</li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2024 The Merbridge Authors All Rights Reserved</small>
<p class=mt-2><a href=/about/>Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>