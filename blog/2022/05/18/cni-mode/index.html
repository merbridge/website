<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Merbridge CNI Mode | Merbridge</title>
<meta name=description content="Merbridge website"><meta property="og:title" content="Merbridge CNI Mode">
<meta property="og:description" content="This blog explains how CNI works in Merbridge.">
<meta property="og:type" content="article">
<meta property="og:url" content="/blog/2022/05/18/cni-mode/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2022-05-18T00:00:00+00:00">
<meta property="article:modified_time" content="2022-05-20T16:48:12+08:00"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="Merbridge CNI Mode">
<meta itemprop=description content="This blog explains how CNI works in Merbridge."><meta itemprop=datePublished content="2022-05-18T00:00:00+00:00">
<meta itemprop=dateModified content="2022-05-20T16:48:12+08:00">
<meta itemprop=wordCount content="735">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Merbridge CNI Mode">
<meta name=twitter:description content="This blog explains how CNI works in Merbridge.">
<link rel=preload href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css as=style>
<link href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class="td-page td-blog">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/docs/><span>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/blog/><span class=active>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/blog/2022/05/18/cni-mode/>中文 Chinese</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.57cd2ed31ceb97a0d5ac139e2393e5ed.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.57cd2ed31ceb97a0d5ac139e2393e5ed.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<div class="nav-item dropdown d-block d-lg-none">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/blog/2022/05/18/cni-mode/>中文 Chinese</a>
</div>
</div>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li>
<a href=/blog/ title="Merbridge Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog2022-li>
<a href=/blog/2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blog2022><span>Blogs of 2022</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20220518cni-mode-li>
<a href=/blog/2022/05/18/cni-mode/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20220518cni-mode><span class=td-sidebar-nav-active-item>Merbridge CNI Mode</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220423merbridge-and-cilium-li>
<a href=/blog/2022/04/23/merbridge-and-cilium/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220423merbridge-and-cilium><span>Merbridge and Cilium</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220329solo-io-livestream-li>
<a href=/blog/2022/03/29/solo-io-livestream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220329solo-io-livestream><span>Livestream with Solo.io</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220301merbridge-introduce-li>
<a href=/blog/2022/03/01/merbridge-introduce/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220301merbridge-introduce><span>Merbridge - Accelerate your mesh with eBPF</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleases-li>
<a href=/blog/releases/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleases><span>Version Release</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220720release-070-li>
<a href=/blog/2022/07/20/release-0.7.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220720release-070><span>Release 0.7.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220523release-060-li>
<a href=/blog/2022/05/23/release-0.6.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220523release-060><span>Release 0.6.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220330release-050-li>
<a href=/blog/2022/03/30/release-0.5.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220330release-050><span>Release 0.5.0</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/merbridge/merbridge/edit/main/content/en/blog/2022/cni-mode/index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/merbridge/merbridge/new/main/content/en/blog/2022/cni-mode/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/merbridge/merbridge/issues/new?title=Merbridge%20CNI%20Mode" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/merbridge/website/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a>
<a id=print href=/blog/2022/_print/><i class="fa fa-print fa-fw"></i> Print entire section</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#why-cni-mode-is-needed>Why CNI mode is needed</a></li>
<li><a href=#how-does-cni-work>How does CNI work</a>
<ul>
<li><a href=#how-to-use-cni-to-let-ebpf-have-the-current-pod-ip>How to use CNI to let eBPF have the current Pod IP</a></li>
<li><a href=#how-to-handle-ingress-traffic>How to handle ingress traffic</a></li>
</ul>
</li>
<li><a href=#how-to-use-cni-mode>How to use CNI mode?</a></li>
<li><a href=#notes>Notes</a>
<ul>
<li><a href=#cni-mode-is-in-beta>CNI mode is in beta</a></li>
<li><a href=#check-whether-the-host-can-enable-the-hardware-checksum-capability>Check whether the host can enable the hardware-checksum capability</a></li>
</ul>
</li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main>
<div class=td-content>
<h1>Merbridge CNI Mode</h1>
<div class=lead>This blog explains how CNI works in Merbridge.</div>
<div class="td-byline mb-4">
<time datetime=2022-05-18 class=text-muted>Wednesday, May 18, 2022</time>
</div>
<header class=article-meta>
<p class=reading-time><i class="fa fa-clock" aria-hidden=true></i> 4 minute read</p>
</header>
<p>The CNI mode is designed to better adapt to the service mesh functions. Before having this mode, Merbridge was limited to certain scenarios. The biggest problem was that it could not adapt to the sidecar annotations from the container injected by Istio, which led to Merbridge cannot exclude traffic from certain ports and IP ranges. Furthermore, Merbridge was only able to handle requests inside the pod, which means the external traffic sent to the pod was not handled.</p>
<p>Therefore, we have implemented the Merbridge CNI to address these issues.</p><!--## 为什么需要 CNI 模式？-->
<h2 id=why-cni-mode-is-needed>Why CNI mode is needed</h2>
<p>First, Merbridge had a small control plane before, which listened to pods resources, and wrote the current node IP into the map of <code>local_pod_ips</code> for use by <code>connect</code>. However, since the <code>connect</code> program only works at the host kernel layer, it won&rsquo;t know which pod&rsquo;s traffic is being processed. Thus, configurations like <code>excludeOutboundPorts</code> cannot be handled. In order to be able to adapt to the injected sidecar annotation <code>excludeOutboundPorts</code>, we need to let the eBPF program know which Pod&rsquo;s request is currently being processed.</p>
<p>To this end, we have designed a method to cooperate with the CNI, through which you can get the current Pod IP to validate special configurations for the Pod.</p>
<p>Second, for early versions of Merbridge, only <code>connect</code> would process requests from the host, which had no problem for intra-node pod communication. However, it becomes problematic when traffic flows between different nodes. According to the previous logic, the traffic will not be modified during the cross-node communication, which will lead to the use of <code>iptables</code> at the end.</p>
<p>Here, we turned to the XDP program for processing the inbound traffic. The XDP program needs to mount a network card, which also needs to use CNI.</p><!--## CNI 如何解决问题？-->
<h2 id=how-does-cni-work>How does CNI work</h2>
<p>This section will explore how CNI works and how to use CNI to solve the issues mentioned above.</p><!--### 如何通过 CNI 让 eBPF 程序获取当前正在处理的 Pod IP？-->
<h3 id=how-to-use-cni-to-let-ebpf-have-the-current-pod-ip>How to use CNI to let eBPF have the current Pod IP</h3>
<p>When a pod is created, we write Pod IP into the map <code>mark_pod_ips_map</code> through CNI, where the key is a random value, and the value is the Pod IP. Then, we listen to a special port <code>39807</code> in the NetNS of the current Pod, and write the key to the mark of this port socket using <code>setsockopt</code>.</p>
<p>In eBPF, we get the recorded mark information of port <code>39807</code> through <code>bpf_sk_lookup_tcp</code>, and use it to get the current Pod IP (also the current NetNS) from <code>mark_pod_ips_map</code>.</p>
<p>With the current Pod IP, we can determine the path to route traffic (such as <code>excludeOutboundPorts</code>) according to the configuration of this Pod.</p>
<p>In addition, we also optimized the quadruple conflicts by using <code>bpf_bind</code> to bind the source IP and using <code>127.0.0.1</code> as the destination IP, which also prepares for future support of IPv6.</p><!--### 如何处理入口流量？-->
<h3 id=how-to-handle-ingress-traffic>How to handle ingress traffic</h3>
<p>In order to handle inbound traffic, we introduced the XDP program, which works on the network card and can modify the original data packets.</p>
<p>We use the XDP program to modify the destination port as <code>15006</code> when the traffic reaches the Pod, so as to complete traffic forwarding.</p>
<p>At the same time, considering the possibility that the host directly accesses the Pod, and in order to reduce the scope of influence, we choose to attach the XDP program to the Pod&rsquo;s network card. This requires the ability of CNI to perform additional operations when creating Pods</p><!--## 如何体验 CNI 模式？-->
<h2 id=how-to-use-cni-mode>How to use CNI mode?</h2>
<p>CNI mode is disabled by default. You need to enable it manually with the following command.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sSL https://raw.githubusercontent.com/merbridge/merbridge/main/deploy/all-in-one.yaml <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/--cni-mode=false/--cni-mode=true/g&#39;</span> <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
</code></pre></div><!--## 注意事项-->
<h2 id=notes>Notes</h2><!--### CNI 模式处于测试阶段-->
<h3 id=cni-mode-is-in-beta>CNI mode is in beta</h3>
<p>The CNI mode is a new feature that may not be perfect. We welcome your feedback and suggestions to help improve Merbridge.</p>
<p>If you are trying to do benchmark test using tools like <code>Istio perf benchmark</code>, it is suggested to enable the CNI mode. Otherwise the test results will be inaccurate.</p><!--### 需要注意主机是否可开启 hardware-checksum 能力-->
<h3 id=check-whether-the-host-can-enable-the-hardware-checksum-capability>Check whether the host can enable the hardware-checksum capability</h3>
<p>In order to ensure the CNI mode works properly, the <code>hardware-checksum</code> capability is disabled by default, which may affect network performance. It is recommended to check whether you can enable this capability on the host before enabling the CNI mode. If yes, we suggest to set <code>--hardware-checksum=true</code> for best performance.</p>
<p>Test method: if <code>ethtool -k &lt;network card> | grep tx-checksum-ipv4</code> is on, it means enabled.</p>
<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
<li>
<a href=/blog/2022/04/23/merbridge-and-cilium/ aria-label="Previous - Merbridge and Cilium" class="btn btn-primary"><span class=mr-1>←</span> Previous</a>
</li>
<a class="btn btn-primary disabled">Next <span class=ml-1>→</span></a>
</li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Merbridge Authors All Rights Reserved</small>
<p class=mt-2><a href=/about/>Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>