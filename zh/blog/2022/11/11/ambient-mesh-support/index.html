<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！ | Merbridge</title>
<meta name=description content="Merbridge 的官网"><meta property="og:title" content="Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！">
<meta property="og:description" content="此篇博客介绍 Merbridge 支持 Ambient Mesh 的新特性。">
<meta property="og:type" content="article">
<meta property="og:url" content="/zh/blog/2022/11/11/ambient-mesh-support/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2022-11-11T00:00:00+00:00">
<meta property="article:modified_time" content="2022-11-15T10:10:01+08:00"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！">
<meta itemprop=description content="此篇博客介绍 Merbridge 支持 Ambient Mesh 的新特性。"><meta itemprop=datePublished content="2022-11-11T00:00:00+00:00">
<meta itemprop=dateModified content="2022-11-15T10:10:01+08:00">
<meta itemprop=wordCount content="437">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！">
<meta name=twitter:description content="此篇博客介绍 Merbridge 支持 Ambient Mesh 的新特性。">
<link rel=preload href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css as=style>
<link href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class="td-page td-blog">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/zh/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/about/><span>关于</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/docs/><span>文档</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/zh/blog/><span class=active>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文 Chinese
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/blog/2022/11/11/ambient-mesh-support/>English</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.cafc22cb5f75f81cb51206ebfa610277.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.cafc22cb5f75f81cb51206ebfa610277.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<div class="nav-item dropdown d-block d-lg-none">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文 Chinese
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/blog/2022/11/11/ambient-mesh-support/>English</a>
</div>
</div>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhblog-li>
<a href=/zh/blog/ title="Merbridge Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhblog><span>Blog</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhblog2022-li>
<a href=/zh/blog/2022/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhblog2022><span>2022 年 Blog</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zhblog20221111ambient-mesh-support-li>
<a href=/zh/blog/2022/11/11/ambient-mesh-support/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhblog20221111ambient-mesh-support><span class=td-sidebar-nav-active-item>Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20221108kuma-20-with-merbridge-li>
<a href=/zh/blog/2022/11/08/kuma-2.0-with-merbridge/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20221108kuma-20-with-merbridge><span>Kuma 2.0 集成 Merbridge 降低 12% 的网络延迟</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20221013ambient-mesh-data-path-li>
<a href=/zh/blog/2022/10/13/ambient-mesh-data-path/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20221013ambient-mesh-data-path><span>深入 Ambient Mesh - 流量路径</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220518cni-mode-li>
<a href=/zh/blog/2022/05/18/cni-mode/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220518cni-mode><span>Merbridge CNI 模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220423merbridge-and-cilium-li>
<a href=/zh/blog/2022/04/23/merbridge-and-cilium/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220423merbridge-and-cilium><span>Merbridge 和 Cilium</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220329solo-io-livestream-li>
<a href=/zh/blog/2022/03/29/solo-io-livestream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220329solo-io-livestream><span>与 Solo.io 一起举办的直播活动</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220301merbridge-introduce-li>
<a href=/zh/blog/2022/03/01/merbridge-introduce/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220301merbridge-introduce><span>一行代码，使用 eBPF 代替 iptables 加速服务网格</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhblogreleases-li>
<a href=/zh/blog/releases/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhblogreleases><span>版本发布</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220720release-070-li>
<a href=/zh/blog/2022/07/20/release-0.7.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220720release-070><span>发布 0.7.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220523release-060-li>
<a href=/zh/blog/2022/05/23/release-0.6.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220523release-060><span>发布 0.6.0</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220127release-050-li>
<a href=/zh/blog/2022/01/27/release-0.5.0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220127release-050><span>Release 0.5.0</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/merbridge/merbridge/edit/main/content/zh/blog/2022/ambient-mesh-support/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/merbridge/merbridge/new/main/content/zh/blog/2022/ambient-mesh-support/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/merbridge/merbridge/issues/new?title=Merbridge%20%e6%94%af%e6%8c%81%20Ambient%20Mesh%ef%bc%8c%e6%97%a0%e6%83%a7%20CNI%20%e5%85%bc%e5%ae%b9%e6%80%a7%ef%bc%81" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/merbridge/website/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
<a id=print href=/zh/blog/2022/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#确定目标>确定目标</a></li>
<li><a href=#分析难点>分析难点</a></li>
<li><a href=#解决方案>解决方案</a></li>
<li><a href=#使用与反馈>使用与反馈</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main>
<div class=td-content>
<h1>Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！</h1>
<div class=lead>此篇博客介绍 Merbridge 支持 Ambient Mesh 的新特性。</div>
<div class="td-byline mb-4">
By <b>Kebe Liu</b> |
<time datetime=2022-11-11 class=text-muted>2022.11.11</time>
</div>
<header class=article-meta>
<p class=reading-time><i class="fa fa-clock" aria-hidden=true></i> 3 分钟 阅读时间</p>
</header>
<p>在 <a href=/zh/blog/2022/10/13/ambient-mesh-data-path/>深入 Ambient Mesh - 流量路径</a> 一文中，我们分析了 Ambient Mesh 如何实现在不引入 Sidecar 的情况下，将特定 Pod 的出入口流量转发到 ztunnel 进行处理。我们可以发现，其通过 iptables + TPROXY + 路由表的方式进行实现，路径比较长，理解起来比较复杂。而且，由于其使用 mark 做路由标记，这可能导致在某些同样依赖 CNI 的网络下无法正常工作，或者在一些 Bridge 模式的网络 CNI 下无法工作，会极大的限制 Ambient Mesh 使用场景。</p>
<p>Merbridge 主要场景就是使用 eBPF 代替 iptables 为服务网格应用加速。Ambient Mesh 作为 Istio 服务网格的全新模式，Merbridge 自然也要支持这种新模式。
iptables 技术强大，为很多软件实现了各种功能，但在实际应用中也存在一些缺陷。首先，iptables 使用线性匹配方式，当多个应用使用相同能力时可能会产生冲突，进而导致某些功能不可用。其次，虽然其足够灵活，但是仍旧无法实现像 eBPF 一样自由编程的能力。
所以，使用 eBPF 技术代替 iptables 的能力，帮助 Ambient Mesh 实现流量拦截，这应该是一项令人兴奋的技术。</p>
<h2 id=确定目标>确定目标</h2>
<p>通过 <a href=/zh/blog/2022/10/13/ambient-mesh-data-path/>深入 Ambient Mesh - 流量路径</a> 一文，我们可以知道的是，我们最终的目标有两个：</p>
<ul>
<li>将位于 Ambient Mesh 模式下的 Pod 向外发出的流量，拦截到 ztunnel 的 15001 端口。</li>
<li>当主机程序向 Ambient Mesh 模式下的 Pod 发送流量时，应该将流量重定向到 ztunnel 的 15006 端口。</li>
</ul>
<p>至于其中的 istioin 等网卡，完全是为了配合 Ambient Mesh 原有模式设计的，所以无需关注。</p>
<h2 id=分析难点>分析难点</h2>
<p>在运行模式上，Ambient Mesh 模式和 Sidecar 模式存在很大区别。根据 Istio 官方的定义，将一个 Pod 加入 Ambient Mesh 并不需要重启 Pod，在 Pod 中也不存在 Sidecar 相关进程，这就意味着两个问题：</p>
<ol>
<li>之前 Merbridge 使用 CNI 的方案，让 eBPF 程序能够感知到当前 Pod 的 IP 地址从而做出策略判断的方式将失效，因为 Pod 加入或移除 Ambient Mesh 模式并不会重启，也不会调用 CNI 插件，需要重新考量。</li>
<li>以前的流量拦截，只需要在 eBPF 的 connect 钩子中，将目标地址改为 <code>127.0.0.1:15001</code>，但是在 Ambient Mesh 模式下，需要将目标 IP 换成 ztunnel 的 IP 地址。</li>
</ol>
<p>同时，由于 Ambient Mesh 模式下的 Pod 中，并不存在 Sidecar 相关进程，所以之前 Merbridge 用查看当前 Pod 中是否监听了 15006 等端口的方式也不再适用，需要重新设计方案判断进程的运行环境。</p>
<p>所以，基于上述分析，基本上需要重新设计整个拦截方案，以便让 Merbridge 支持 Ambient Mesh 模式。</p>
<p>总结下来，我们需要做这些事情：</p>
<ul>
<li>重新设计判断 Pod 是否加入 Ambient Mesh 模式的方案</li>
<li>不依赖 CNI，实现 eBPF 感知当前 Pod IP 的方案</li>
<li>让 eBPF 程序知道当前节点的 ztunnel 的 IP 地址方案</li>
</ul>
<h2 id=解决方案>解决方案</h2>
<p>在 0.7.2 版本中，我们引入了使用 cgroup id 加速 connect 程序的性能。通常每一个 Pod 中的容器都有一个对应的 cgroup id，我们可以在 bpf 程序中，通过 <code>bpf_get_current_cgroup_id</code> 函数获取到。通过将 IP 信息写入专用的 <code>cgroup_info_map</code> ，可以优化 connect 程序的运行速度。</p>
<p>之前 CNI 在网络命名空间中监听一个特殊的端口，用于存储 Pod 的信息，而 Ambient Mesh 模式与此不同。在 Ambient Mesh 模式中可以借助 cgroup id，如果能将 cgroup id 与 Pod IP 产生关联，那就可以在 eBPF 中获取到当前 Pod IP 信息。</p>
<p>由于不能依赖 CNI，所以需要改变获取 Pod 状态变更信息的方案。为此，我们通过观测进程的创建和销毁信息来探测本地 Pod 的创建和销毁等操作，创建了一个新的工具，用来观测主机上进程的变更信息：<a href=https://github.com/merbridge/process-watcher>process-watcher 项目</a>。</p>
<p>通过从进程 ID 读取所在的 cgroup id 和 ip 信息并将其写入 <code>cgroup_info_map</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#000>tcg</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cgroupInfo</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>ID</span><span style=color:#000;font-weight:700>:</span>            <span style=color:#000>cgroupInode</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>IsInMesh</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>CgroupIp</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>uint32</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>_ip</span><span style=color:#000;font-weight:700>),</span>
		<span style=color:#000>Flags</span><span style=color:#000;font-weight:700>:</span>         <span style=color:#000>flag</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>DetectedFlags</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>cgrinfo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DetectedFlags</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000>AMBIENT_MESH_MODE_FLAG</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000>ZTUNNEL_FLAG</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ebpfs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetCgroupInfoMap</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Update</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroupInode</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tcg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ebpf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateAny</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>然后在 eBPF 中获取到当前 cgroup 所关联的信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>__u64</span> <span style=color:#000>cgroup_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_get_current_cgroup_id</span><span style=color:#000;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_map_lookup_elem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroup_info_map</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cgroup_id</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>通过这里，我们可以知道，当前的容器是否启用了 Ambient Mesh 模式、是否在网格中等信息。</p>
<p>其次，对于 ztunnel 的 IP 地址，Istio 通过增加网卡绑定固定 IP 的方式实现，这种方案可能存在冲突的风险，也可能在某些情况下（比如 SNAT）会造成原地址信息丢失的情况。所以 Merbridge 放弃了此方案，直接在控制面获取 ztunnel 的 IP 地址，写入 map，让 eBPF 程序读取（这样速度更快）。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>inline</span> <span style=color:#000>__u32</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>get_ztunnel_ip</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>__u32</span> <span style=color:#000>ztunnel_ip_key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ZTUNNEL_KEY</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>__u32</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#000>bpf_map_lookup_elem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>settings</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>ztunnel_ip_key</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>然后，可以利用 connect 程序，重写目标地址：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>user_ip4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ztunnel_ip</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>];</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>user_port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bpf_htons</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>OUT_REDIRECT_PORT</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>通过与 cgroup id 的关联，可以实现在 eBPF 中获取当前进程所在的 Pod IP 地址，从而进行策略操作，将 Ambient Mesh 模式下 Pod 发出的流量转发到 ztunnel 进行处理，从而实现 Merbridge 在 Ambient Mesh 模式下的兼容。</p>
<p>这将是对所有 CNI 都适配的一种能力，可以避免原有 Ambient Mesh 模式不能很好的在大多数 CNI 模式下无法工作的问题。</p>
<h2 id=使用与反馈>使用与反馈</h2>
<p>由于目前 Ambient 仍处于早期阶段，且 Merbridge 对于 Ambient 模式的支持也相对初级，还有一些问题没有得到很好的解决，所以 Ambient 模式还没有合并入主分支。如果想要体验 Merbridge 代替 iptables 为 Ambient Mesh 实现流量拦截的能力，可以按照如下的方式操作（首先需要安装好 Ambient Mesh 模式的网格）：</p>
<ol>
<li>禁用 Istio CNI（安装时设置 <code>--set components.cni.enabled=false</code> ，或删除 Istio CNI 的 DaemonSet <code>kubectl -n istio-system delete ds istio-cni</code> 的方式）。</li>
<li>删除 ztunnel 的 init 容器（因为它会初始化 iptables 规则、网卡等，而 Merbridge 不需要这个操作）。</li>
<li>使用 <code>kubectl apply -f https://github.com/merbridge/merbridge/raw/ambient/deploy/all-in-one.yaml</code> 安装支持 Merbridge 。</li>
</ol>
<p>等待 Merbridge 就绪之后，即可以使用 Ambient Mesh 的所有能力。</p>
<p>*<strong>注意：</strong></p>
<ol>
<li>当前不支持在 Kind 下使用 Ambient 模式（将在后续支持）；</li>
<li>主机内核版本需要大于等于 5.7；</li>
<li>需要开启 cgroup v2；</li>
<li>此模式也兼容 Sidecar 模式；</li>
<li>Ambient 模式下安装默认会开启 debug 模式，会对性能造成一定影响。</li>
</ol>
<p>更多实现细节可以查看<a href=https://github.com/merbridge/merbridge/tree/ambient>源码</a>。</p>
<p>如果遇到任何问题，可在 <a href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ>Slack</a> 中与我们反馈，或加入我们的技术交流微信群。</p>
<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
<li>
<a href=/zh/blog/2022/11/08/kuma-2.0-with-merbridge/ aria-label="上一页 - Kuma 2.0 集成 Merbridge 降低 12% 的网络延迟" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a>
</li>
<a class="btn btn-primary disabled">下一页 <span class=ml-1>→</span></a>
</li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2023 The Merbridge Authors 版权所有</small>
<p class=mt-2><a href=/zh/about/>关于 Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>