<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><link rel=canonical type=text/html href=/zh/docs/overview/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>概览 | Merbridge</title>
<meta name=description content="Merbridge 的官网"><meta property="og:title" content="概览">
<meta property="og:description" content="希望您阅读本页后，能够对 Merbridge 有一个大体的了解。
">
<meta property="og:type" content="website">
<meta property="og:url" content="/zh/docs/overview/"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="概览">
<meta itemprop=description content="希望您阅读本页后，能够对 Merbridge 有一个大体的了解。
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="概览">
<meta name=twitter:description content="希望您阅读本页后，能够对 Merbridge 有一个大体的了解。
">
<link rel=preload href=/scss/main.min.bd5285b713d3061549a6bfd34e5f4ec6775ede36672a3088260f0d420050647f.css as=style>
<link href=/scss/main.min.bd5285b713d3061549a6bfd34e5f4ec6775ede36672a3088260f0d420050647f.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/zh/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/about/><span>关于</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/blog/><span>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文 Chinese
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/docs/overview/>English</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.31179286907cffa54d4c47bb06a45800.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/zh/docs/overview/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>概览</h1>
<div class=lead>希望您阅读本页后，能够对 Merbridge 有一个大体的了解。</div>
<ul>
</ul>
<div class=content>
<h2 id=什么是-merbridge>什么是 Merbridge</h2>
<p>Merbridge 是一个专门为服务网格设计，用于代替传统的 iptables 流量劫持技术，让服务网格的流量拦截和转发能力更加高效。</p>
<p>eBPF (extended Berkeley Packet Filter) 是一种可以在 Linux 内核中运行用户编写的程序且不需要修改内核代码或加载内核模块的技术，目前被广泛用于网络、安全、监控等领域。相比传统的 iptables 流量劫持技术，Merbridge 可以绕过很多内核模块，缩短边车和服务间的数据路径，从而起到网络加速的作用。同时，Merbridge 没有对现有的 Istio 作出任何修改，原有的逻辑依然畅通。这意味着，如果您不想继续使用 eBPF，可以直接删除 DaemonSet，改为传统的 iptables 方式也不会出现任何问题。</p>
<h2 id=merbridge-有哪些特性>Merbridge 有哪些特性</h2>
<p>Merbridge 的核心特性包括：</p>
<ul>
<li>
<p>入口流量处理</p>
<p>Merbridge 使用 eBPF 的 connect 程序，通过修改 user_ip 和 user_port 修改连接发起时的目的地址，让流量能够发送到新的接口。为了让 Envoy 识别出原始的目的地址，应用程序（包括 Envoy）会在收到连接之后调用 get_sockopts 函数，获取 ORIGINAL_DST。</p>
</li>
<li>
<p>出口流量处理</p>
<p>出口流量处理与入口流量处理大体类似。需要注意的是，eBPF 是全局性的，不能在指定的命名空间生效。因此，如果对本来不由 Istio 管理的 Pod 或者一个外部的 IP 地址执行此操作，就会导致请求无法建立连接。所以这里设计了一个小的控制平面（以 DaemonSet 方式部署），通过 Watch 所有的 Pod，类似于 kubelet 那样获取当前节点的 Pod 列表，将已经被注入 Sidecar 的 Pod IP 地址写入 local_pod_ips map。如果目的地址不在这个列表之中， Merbridge 就不做处理，而使用原来的逻辑。这样就可以灵活且简单地处理入口流量。</p>
</li>
<li>
<p>同节点加速</p>
<p>在 Istio 中，Envoy 访问应用的方式是使用当前 PodIP 加服务端口。由于 PodIP 肯定也存在于 local_pod_ips 中，那么请求就会被转发到 PodIP + 15006 端口。这会造成无限递归，不能在 eBPF 获取当前命名空间的 IP 地址信息。因此，需要一套反馈机制。在 Envoy 尝试建立连接时，仍然重定向到 15006 端口，但在 sockops 阶段判断源 IP 和目的地址 IP是否一致。如果一致，则说明发送了错误的请求，需要在 sockops 丢弃这个连接，并将当前的 ProcessID 和 IP 地址信息写入 process_ip map，让 eBPF 支持进程和 IP 的对应关系。下次请求发送时直接从 process_ip 表检查目的地址是否与当前 IP 地址一致。Envoy 会在请求失败的时候重试，且这个错误只会发生一次，后续的连接会非常快。</p>
</li>
</ul>
<h2 id=为什么需要-merbridge>为什么需要 Merbridge</h2>
<p>在服务网格的场景中，为了能够在应用完全无感知的情况下利用边车进行流量治理，需要把 Pod 的出入口流量都转发到边车进行治理。在这种情况下，最通用的技术就是使用 iptables(netfilter) 的 Redirect 能力，将原本的流量转发到边车，从而实现流量治理和其它相应功能。这种方案的缺点是增加了网络延迟，因为 iptables 对出口流量和入口流量都进行拦截。以入口流量为例，原本直接流向应用的流量，需要先由 iptables(netfilter) 转发到边车，再由边车将流量转发到实际的应用。原本只需要在内核态处理两次的链路如今变成四次，损失了不少性能。</p>
<p>幸运的是，eBPF 技术提供了一个 bpf_msg_redirect_hash 函数，可以将应用发出的数据包直接转发到对端的 socket 上面，从而极大地加速数据包在内核中的处理流程。我们希望用 eBPF 技术代替 iptables(netfilter)，提高服务网格的效率。于是 Merbridge 就这样诞生了。</p>
<h2 id=merbridge-适用哪些场景>Merbridge 适用哪些场景</h2>
<p>如果您的环境存在下列任一问题，建议考虑使用 Merbridge：</p>
<ul>
<li>使用 iptables 实现透明劫持需要借助 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况。</li>
<li>iptables 全局生效，不能显式的禁止相关联的修改，可管控性比较差。</li>
<li>在大并发、需要高性能连接的场景下，使用 iptables 会增加延迟。</li>
<li>如果系统因为某些原因不能使用 iptables。</li>
<li>某些特殊情况下不能为普通的 Pod 授予太多权限（如 init 容器可能需要 NET_ADMIN 等权限）。　</li>
</ul>
<h2 id=使用-merbridge-后连接关系有什么变化>使用 Merbridge 后连接关系有什么变化</h2>
<p>使用 eBPF 在主机上对相应的连接进行处理，可以大幅度减少内核处理流量的流程，提升服务之间的通讯质量。</p>
<ul>
<li>如果不用 Merbridge (eBPF)，Pod 到 Pod 间的访问连接关系如下图所示：
<img src=./imgs/5.png alt="iptable 路径"></li>
<li>使用 Merbridge (eBPF) 优化之后，处理出入口流量时会跳过很多内核模块，从而加速网络。
<img src=./imgs/6.png alt="eBPF 路径"></li>
<li>如果两个 Pod 在同一台机器上，使用 Merbridge (eBPF) 能让 Pod 之间的通讯更加高效。
<img src=./imgs/7.png alt="同节点 eBPF 路径"></li>
</ul>
<p>Merbridge 是一个完全独立的开源项目（Github 地址：https://github.com/merbridge/merbridge），但目前仍处于早期阶段。希望有更多的用户或开发者参与其中，不断完善 Merbridge，共同优化服务网格。　　</p>
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Merbridge Authors 版权所有</small>
<p class=mt-2><a href=/zh/about/>关于 Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>