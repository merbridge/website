<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><link rel=canonical type=text/html href=/docs/overview/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Overview | Merbridge</title>
<meta name=description content="Merbridge website"><meta property="og:title" content="Overview">
<meta property="og:description" content="This page provides an overview of Merbridge.
">
<meta property="og:type" content="website">
<meta property="og:url" content="/docs/overview/"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="Overview">
<meta itemprop=description content="This page provides an overview of Merbridge.
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Overview">
<meta name=twitter:description content="This page provides an overview of Merbridge.
">
<link rel=preload href=/scss/main.min.bd5285b713d3061549a6bfd34e5f4ec6775ede36672a3088260f0d420050647f.css as=style>
<link href=/scss/main.min.bd5285b713d3061549a6bfd34e5f4ec6775ede36672a3088260f0d420050647f.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/docs/overview/>中文 Chinese</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.70ff423c1e08dccb67944fc2661caba5.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/docs/overview/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Overview</h1>
<div class=lead>This page provides an overview of Merbridge.</div>
<ul>
</ul>
<div class=content>
<h2 id=what-is-merbridge>What is Merbridge</h2>
<p>Merbridge is designed to make traffic interception and forwarding more efficient for service meshes by replacing iptables with eBPF.</p>
<p>eBPF (extended Berkeley Packet Filter) can run user&rsquo;s programs in the Linux kernel without modifying the kernel code or loading kernel modules. It is widely used in networking, security, monitoring and other fields. Compared with iptables, Merbridge can shorten the data path between sidecars and services and therefore accelerate network. Meanwhile, Merbridge will not change the original architecture of Istio, and the original logic is still smooth. This means that if you don&rsquo;t want Merbridge anymore, just delete the DaemonSet and return to the traditional iptables. No more actions will be needed.</p>
<h2 id=what-merbridge-can-do>What Merbridge can do</h2>
<p>Merbridge has following core features:</p>
<ul>
<li>Processing outbound traffic</li>
</ul>
<p>Merbridge uses eBPF’s <code>connect</code> program to modify <code>user_ip</code> and <code>user_port</code>, so as to modify the destination address of a connection and ensure traffic can be sent to the new interface. In order to make Envoy identify the original destination address, the application (incl. Envoy) will call the <code>get_sockopt</code> function to obtain <code>ORIGINAL_DST</code> when receiving a connection.</p>
<ul>
<li>Processing inbound traffic</li>
</ul>
<p>The processing of inbound traffic is basically similar to outbound traffic. Note that eBPF cannot take effect in a specified namespace like iptables. The changes will be global. It means that if we use a Pod that is not originally managed by Istio, or an external IP address, serious problems will be encountered — like the connection not being established at all.</p>
<p>As a result, we designed a tiny control plane (deployed as a DaemonSet), which watches all pods — similar to the kubelet watching pods on the node — to write the pod IP addresses that have been injected into the sidecar to the <code>local_pod_ips</code> map. If the destination address is not in the map, Merbridge will not do anything to the original traffic.</p>
<ul>
<li>Accelerating</li>
</ul>
<p>In Istio, Envoy accesses the application by using the current pod IP and port number. Because the pod IP exists in the <code>local_pod_ips</code> map as well, the traffic will be redirected to the pod IP on port 15006, producing an infinite loop. Are there any ways to get the IP address in the current namespace with eBPF? Yes! We have designed a feedback mechanism: When Envoy tries to establish a connection, we redirect it to port 15006. However, in the sockops step, we will determine if the source IP and the destination IP are the same. If yes, it means the wrong request is sent, and we will discard this connection in the sockops process. In the meantime, the current ProcessID and IP information will be written into the <code>process_ip map</code> to allow eBPF to support corresponding relationship between processes and IPs. When the next request is sent, We will check directly from the <code>process_ip map</code> if the destination address is the same as the current IP address. Envoy will retry when the request fails, and this retry process will only occur once, meaning subsequent requests will be accelerated.</p>
<h2 id=why-need-merbridge>Why need Merbridge</h2>
<p>In the service mesh scenario, in order to use the sidecar for traffic management without the application being aware of it, the ingress and egress traffic of the Pod will be forwarded to the sidecar. The most common way for this is using the redirect capability of iptables (netfilter) to forward the original traffic to the sidecar. However, this approach will increase network latency, because iptables intercepts both egress and ingress traffic. Take ingress traffic as an example. The traffic that originally flows directly to the application needs to be forwarded to the sidecar by iptables (netfilter), and then the sidecar will forward the traffic to the actual application. The data path becomes very long, since duplicated steps are performed several times.</p>
<p>Luckily, eBPF provides a function bpf_msg_redirect_hash, to directly forward the packets sent by the application in the inbound socket to the outbound socket. By doing so, packet processing can be greatly accelerated in the kernel. Therefore, we hope to replace iptables with eBPF. That&rsquo;s how Merbridge came into being.</p>
<h2 id=when-to-use-merbridge>When to use Merbridge</h2>
<p>Merbridge is recommended if you have following problems:</p>
<ul>
<li>iptables takes effect globally and related modifications cannot be explicitly prohibited, resulting in poor controllability.</li>
<li>When large concurrency and high-performance connections are required, using iptables will increase latency.</li>
<li>Your system cannot use iptables for certain reasons.</li>
<li>You cannot give ordinary Pods too many permissions for certain reasons (e.g., the init container may require NET_ADMIN and other permissions).</li>
<li>Using iptables for transparent interception requires connection tracking feature of the conntrack module. This means great overhead and alos maybe a full track table in the case of a large number of connections.</li>
</ul>
<h2 id=what-merbridge-will-change>What Merbridge will change</h2>
<p>Using eBPF to process connections on the host can greatly simplify the kernel&rsquo;s processing of traffic and improve the communication quality between services.</p>
<ul>
<li>Before applying eBPF using Merbridge, the data path between pods is like:</li>
</ul>
<p><img src=imgs/iptables_Path.png alt="iptable path"></p>
<ul>
<li>After applying Merbridge, the outbound traffic will skip many filter steps to improve the performance:</li>
</ul>
<p><img src=imgs/eBPF_Path.png alt="eBPF path"></p>
<ul>
<li>If two pods are on the same node, the connection can even be faster:</li>
</ul>
<p><img src=imgs/sameNode_eBPF_Path.png alt="same-node eBPF path"></p>
<p><a href=https://github.com/merbridge/merbridge>Merbridge</a> is a completely independent open source project. It is still at an early stage, and we are looking forward to having more users and developers to get engaged. It would be greatly appreciated if you would try this new technology to accelerate your mesh, and provide us with some feedback!　</p>
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Merbridge Authors All Rights Reserved</small>
<p class=mt-2><a href=/about/>Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>