<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0"><link rel=canonical type=text/html href=/docs/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Documentation | Merbridge</title>
<meta name=description content="Merbridge website"><meta property="og:title" content="Documentation">
<meta property="og:description" content="Merbridge website">
<meta property="og:type" content="website">
<meta property="og:url" content="/docs/"><meta property="og:site_name" content="Merbridge">
<meta itemprop=name content="Documentation">
<meta itemprop=description content="Merbridge website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Documentation">
<meta name=twitter:description content="Merbridge website">
<link rel=preload href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css as=style>
<link href=/scss/main.min.957d988e396d495afa3156d4640b99742d961f39c79e92f8d152969969aa9ece.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Graph" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><style>.cls-1{fill:#33de72}.cls-2{fill:#fff}.cls-3{fill:none}</style></defs><g id="Merbridge_-_Graph_-_Color_Light" data-name="Merbridge - Graph - Color Light"><path id="Primary" class="cls-1" d="M440 86.059V454l-48-48V201.941l-44 44V178.059zm-184 184c-34.6-34.6-151.526-151.526-184-184V454l48-48V201.941l136 136 44-44V226.059z"/><path id="Secondary" class="cls-2" d="M212 382l-48 48V245.941l48 48zm0-155.941V48L164 96v82.059zM3e2 48V382l48 48V96z"/><rect id="Frame" class="cls-3" width="512" height="512"/></g></svg></span><span class="text-uppercase font-weight-bold">Merbridge</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>About</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>Blog</span></a>
</li>
<li class="nav-item dropdown mr-4 d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/docs/>中文 Chinese</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d4ad5be248f41d95a93b36adc6bdeb7b.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/docs/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Documentation</h1>
<ul>
<li>1: <a href=#pg-4945894b7164a800c7f7895256065f85>Overview</a></li>
<li>2: <a href=#pg-93aadc1aba179e6928539400a09b9e4e>Quick Start</a></li>
<ul>
</ul>
<li>3: <a href=#pg-fcf6186c3c17ed7f2e8577136109a520>Concepts</a></li>
<ul>
</ul>
<li>4: <a href=#pg-8efbf7499fe9c7bde8d2c1bb7ff6ee3c>Make Contributions</a></li>
<ul>
</ul>
</ul>
<div class=content>
<div class="pageinfo pageinfo-primary">
<p>Get all information you need to know about Merbridge.</p>
</div>
<p>Merbridge is eBPF-based and can accelerate the data plane of service meshes with a shorter packet datapath than iptables.</p>
</div>
</div>
<div class=td-content>
<h1 id=pg-4945894b7164a800c7f7895256065f85>1 - Overview</h1>
<div class=lead>This page outlines Merbridge and its features, applicable scenarios, and competitiveness.</div>
<h2 id=what-is-merbridge>What is Merbridge</h2>
<p>Merbridge is designed to make traffic interception and forwarding more efficient for service mesh. It replaced iptables with eBPF.</p>
<p>eBPF (extended Berkeley Packet Filter) can run user&rsquo;s programs in the Linux kernel without modifying the kernel code or loading kernel modules. It is widely used in networking, security, monitoring and other relevant fields. Compared with iptables, Merbridge can shorten the data path between sidecars and services and therefore accelerate networking. Meanwhile, using Merbridge will not change the original architecture of Istio. The original logic is still valid. This means that if you don&rsquo;t want Merbridge anymore, just delete the DaemonSet. The original iptables will function again without any troubles.</p>
<h2 id=what-merbridge-can-do>What Merbridge can do</h2>
<p>Merbridge has following core features:</p>
<ul>
<li>
<p>Processing outbound traffic</p>
<p>Merbridge uses eBPF’s <code>connect</code> program to modify <code>user_ip</code> and <code>user_port</code>, so as to change the destination address of a connection and ensure traffic can be sent to the new interface. In order to help Envoy identify the original destination, the application (incl. Envoy) will call the <code>get_sockopt</code> function to get <code>ORIGINAL_DST</code> when receiving a connection.</p>
</li>
<li>
<p>Processing inbound traffic</p>
<p>Inbound traffic is processed similarly to outbound traffic. Note that eBPF cannot take effect in a specified namespace like iptables, so changes will be global. It means that if we apply eBPF to Pods that are not originally managed by Istio, or an external IP, serious problems will occur, e.g., cannot establish a connection.</p>
<p>To address this issue, we designed a tiny control plane, deployed as a DaemonSet. It can help watch and get a list of all pods on the node, similar to kubelet. Then, Pod IPs injected into the sidecar will be written into the <code>local_pod_ips</code> map. For traffic with a destination address not in the map, Merbridge will not intercept it.</p>
</li>
<li>
<p>Accelerating networking</p>
<p>In Istio, Envoy visits the application by the current podIP and port number. Because the podIP exists in the <code>local_pod_ips</code> map, traffic will be redirected to the podIP on port 15006, producing an infinite loop. Are there any ways for eBPF to get the IP address in the current namespace? Yes! We have designed a feedback mechanism: When Envoy tries to establish a connection, we redirect it to port 15006. When it moves to sockops, we will check if the source IP and the destination IP are the same. If yes, it means the wrong request is sent, and we will discard it in the sockops process. Meanwhile, the current ProcessID and IP will be written into the <code>process_ip map</code>, allowing eBPF to support corresponding relationship between processes and IPs. When the next request is sent, we will check directly from the <code>process_ip map</code> if the destination is the same as the current IP. Envoy will retry when the request fails. This retry process will only occur once, and subsequent connections will go very fast.</p>
</li>
</ul>
<h2 id=why-merbridge-is-better>Why Merbridge is better</h2>
<p>In the service mesh scenario, in order to use sidecars for traffic management without the application being aware of it, ingress and egress traffic of Pods should be forwarded to the sidecar. The most common solution is using the redirect capability of iptables (netfilter) to forward the original traffic. However, this approach will increase network latency, because iptables intercept both egress and ingress traffic. For example, the traffic that originally flows directly to the application now is forwarded to the sidecar by iptables (netfilter), and the sidecar will then forward it to the final application. The data path becomes very long, since duplicated steps are performed several times.</p>
<p>Luckily, eBPF provides a function <code>bpf_msg_redirect_hash</code> to directly forward packets from applications in the inbound socket to the outbound socket. By doing so, packet processing can be greatly accelerated in the kernel. Therefore, we hope to replace iptables with eBPF. That&rsquo;s how Merbridge came into being.</p>
<h2 id=when-to-use-merbridge>When to use Merbridge</h2>
<p>Merbridge is recommended if you have any of following problems:</p>
<ol>
<li>In scenarios that require high-performance connections, using iptables will increase latency.
<ul>
<li>The performance of iptables control plane and data plane degrades dramatically as the number of containers in the cluster increases. It needs to traverse and modify all the rules every time a new rule is added.</li>
<li>Systems that use IP addresses for security filtering will come under increasing pressure as Pod lifecycle is getting shorter, sometimes just a few seconds, because it requires more frequent updates of iptables rules.</li>
<li>Using iptables to achieve transparent interception needs a conntrack module for connection trace. It will cause a lot of consumption when there are many connections.</li>
</ul>
</li>
<li>The system cannot use iptables for some reasons.
<ul>
<li>Sometimes it needs to process numerous active connections simultaneously, but using iptables is easily to have a full conntrack table.</li>
<li>Sometimes numerous connections should be processed in one second, which will exceed limit of the conntrack table. For example, if you try to process 1100 connections per second with timeout set as 120 seconds and a table capacity of 128k, it would exceed the conntrack table&rsquo;s limit (128k/120 seconds = 1092 connections/second).</li>
</ul>
</li>
<li>Due to security concerns, some ordinary Pods cannot have too many permissions, but using Istio (without CNI) must allow these Pods to gain more permissions.
<ul>
<li>Running the init container may require permissions such as <code>NET_ADMIN</code>.</li>
<li>Running an iptables command may need <code>CAP_NET_ADMIN</code> permission.</li>
<li>Mounting a file system may need <code>CAP_SYS_ADMIN</code> permission.</li>
</ul>
</li>
</ol>
<h2 id=what-merbridge-will-change>What Merbridge will change</h2>
<p>Using eBPF can greatly simplify the kernel&rsquo;s processing of traffic and make inter-service communication more efficient.</p>
<ul>
<li>
<p>Before applying eBPF with Merbridge, the data path between pods is like:</p>
<p><img src=./imgs/iptables_path.png alt="iptable path"></p>
<blockquote>
<p>Diagram From: <a href=https://pt.slideshare.net/ThomasGraf5/accelerating-envoy-and-istio-with-cilium-and-the-linux-kernel/22>Accelerating Envoy and Istio with Cilium and the Linux Kernel</a></p>
</blockquote>
</li>
<li>
<p>After applying Merbridge, the outbound traffic can skip many filter steps to improve performance:</p>
<p><img src=./imgs/eBPF_path.png alt="eBPF path"></p>
<blockquote>
<p>Diagram From: <a href=https://pt.slideshare.net/ThomasGraf5/accelerating-envoy-and-istio-with-cilium-and-the-linux-kernel/22>Accelerating Envoy and Istio with Cilium and the Linux Kernel</a></p>
</blockquote>
</li>
<li>
<p>If two pods are on the same node, the connection will be even faster:</p>
<p><img src=./imgs/sameNode_eBPF_path.png alt="same-node eBPF path"></p>
<blockquote>
<p>Diagram From: <a href=https://pt.slideshare.net/ThomasGraf5/accelerating-envoy-and-istio-with-cilium-and-the-linux-kernel/22>Accelerating Envoy and Istio with Cilium and the Linux Kernel</a></p>
</blockquote>
</li>
</ul>
<p><a href=https://github.com/merbridge/merbridge>Merbridge</a> is a completely independent open source project. It is still at an early stage, and we wish to have more users and developers engaged in. It would be greatly appreciated if you would try this new technology to accelerate your mesh, and provide us with some feedback!</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-93aadc1aba179e6928539400a09b9e4e>2 - Quick Start</h1>
<div class=lead>This page helps you quickly get started with Merbridge.</div>
<h2 id=prerequisites>Prerequisites</h2>
<ol>
<li>Use kernel <code>5.7</code> or a higher version. Check your version with <code>name -r</code>.</li>
<li>Activate <code>cgroup2</code> in your system. Check the status with <code>mount | grep cgroup2</code>.</li>
</ol>
<h2 id=installation>Installation</h2>
<p>Merbridge can be installed on Istio and Linkerd2 only.</p>
<h3 id=installation-on-istio>Install on Istio</h3>
<p>Apply the following command to install Merbridge:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/merbridge/merbridge/main/deploy/all-in-one.yaml
</code></pre></div><h3 id=installation-on-linkerd>Install on Linkerd2</h3>
<p>Apply the following command to install Merbridge:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/merbridge/merbridge/main/deploy/all-in-one-linkerd.yaml
</code></pre></div><h2 id=verification>Verification</h2>
<h3 id=verification-installation>Verify installation</h3>
<p>Before you start this verification, make sure all Pods relevant to Merbridge are running well. You can check Pod status in Istio with the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n istio-system get pods
</code></pre></div><p>If all these Pods are <code>Running</code>, it means Merbridge is successfully installed.</p>
<h3 id=verification-connection-test>Verify connection</h3>
<p>Use the following methods to check the connectivity of Merbridge:</p>
<h4 id=install-sleep-and-helloworld-and-wait-for-a-full-start>Install sleep and helloworld and wait for a full start</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl label ns default istio-injection<span style=color:#ce5c00;font-weight:700>=</span>enabled
kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/sleep/sleep.yaml
kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/helloworld/helloworld.yaml
</code></pre></div><h4 id=conduct-curl-test>Conduct curl test</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl <span style=color:#204a87>exec</span> <span style=color:#204a87;font-weight:700>$(</span>kubectl get po -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>sleep -o<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{..metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span> -c sleep -- curl -s -v helloworld:5000/hello
</code></pre></div><p>If you see words like <code>* Connected to helloworld (127.128.0.1) port 5000 (#0)</code> in the output, it means Merbridge has managed to replace iptables with eBPF for traffic forwarding.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fcf6186c3c17ed7f2e8577136109a520>3 - Concepts</h1>
<div class=lead>This page describes some key concepts about Merbridge.</div>
<h2 id=ebpf>eBPF</h2>
<p>The full name of eBPF is Extended Berkeley Packet Filter. As the name implies, this is a module used to filter network packets. For example, sockops and redir capabilities of eBPF can efficiently filter and intercept packets.</p>
<p>eBPF is a revolutionary technology with origins in the Linux kernel that can run sandboxed programs in an operating system kernel. It is used to safely and efficiently extend the capabilities of the kernel without requiring to change kernel source code or load kernel modules.</p>
<h2 id=iptables>iptables</h2>
<p>iptables is a traffic filter built on netfilter. It implements traffic filtering and interception by registering hook functions on the mount point of netfilter. From the name of iptables, we can guess it may contain some tables. In practice, by mounting rule tables on different chains of netfilter, iptables can filter or modify the traffic packets entering and leaving the kernel protocol stack.</p>
<p>iptables has 4 tables by default:</p>
<ul>
<li>Filter</li>
<li>NAT</li>
<li>Raw</li>
<li>Mangle</li>
</ul>
<p>iptables has 5 chains by default:</p>
<ul>
<li>INPUT chain (ingress rules)</li>
<li>OUTPUT chain (egress rules)</li>
<li>FORWARD chain (rules of forwarding)</li>
<li>PREROUTING chain (rules before routing)</li>
<li>POSTROUTING chain (rules after routing)</li>
</ul>
<h2 id=service-mesh>Service Mesh</h2>
<p>A service mesh is a dedicated infrastructure layer for handling service-to-service communication. It’s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. A service mesh can guarantee fast, reliable, and secure communication between containerized application infrastructure services. Key capabilities provided by mesh include service discovery, load balancing, secure encryption and authentication, failover, observability, and more.  </p>
<p>A service mesh typically injects a sidecar proxy into each service instance. These sidecars handle inter-service communication, monitoring, and security. In this way, developers can focus on the development, support, and maintenance of the application code in the service, while the O&M team is responsible for the maintenance of the service mesh and applications. </p>
<p>Today, the most well-known service mesh is Istio.</p>
<h2 id=istio>Istio</h2>
<p>Istio is a service mesh technology originally open sourced by IBM, Google, and Lyft. It can be layered transparently onto distributed applications and provides all the benefits of a service mesh, such as traffic governance, security, and observability.</p>
<p>Istio can adapt to all services hosted with on-premises, cloud, Kubernetes containers, and virtual machines. It is typically used with microservices deployed on a Kubernetes platform.</p>
<p>Fundamentally, Istio works by deploying an extended version of Envoy as a sidecar proxy to each microservice. The proxy network it uses forms a data plane of Istio. The configuration and management of these proxies is done in a control plane, providing discovery, configuration, and certificate management for Envoy proxies in the data plane.</p>
<h2 id=linkerd>Linkerd</h2>
<p>Linkerd is the first service mesh launched on the market, but Istio is more popular today.</p>
<p>Linkerd is an open source, ultra-lightweight service mesh designed by Buoyant for Kubernetes. It is completely rewritten in Rust, which makes it as small, light and safe as possible. It provides runtime debugging, observability, reliability, and safety without code changes in distributed applications.</p>
<p>Linkerd has three basic components: UI, data plane, and control plane. Linkerd works by installing a set of ultra-light, transparent proxies next to each service instance that automatically handle all traffic to and from the service.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8efbf7499fe9c7bde8d2c1bb7ff6ee3c>4 - Make Contributions</h1>
<div class=lead>This page helps you make contributions to Merbridge.</div>
<p>Merbridge is currently hosted on GitHub as an open source project. All code-related issues are managed on GitHub.</p>
<p>If you have any questions or suggestions about Merbridge, please <a href=https://github.com/merbridge/merbridge/issues>create a New Issue</a> on GitHub. We will review and process it as soon as possible.</p>
<p>If you find a bug in Merbridge and are interested in helping us fix it, you are more than welcome to share your fix code by <a href=https://github.com/merbridge/merbridge/pulls>creating a Pull Request</a>. We will review and process it as soon as possible.</p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="User mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/merbridge/merbridge aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://join.slack.com/t/merbridge/shared_invite/zt-11uc3z0w7-DMyv42eQ6s5YUxO5mZ5hwQ aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/merbridge aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 The Merbridge Authors All Rights Reserved</small>
<p class=mt-2><a href=/about/>Merbridge</a></p>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>